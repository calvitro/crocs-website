{{- $dir := .Get "dir" -}}
{{- $class := .Get "class" -}}
{{- $webp := .Get "webp" | default "true" -}}
{{- $zoomable := .Get "zoomable" | default "false" -}}

<div class="gallery {{ $class }}">
  {{- $galleryDir := path.Join "assets" $dir -}}
  {{- range (readDir $galleryDir) -}}
    {{- if not .IsDir -}}
      {{- $name := .Name -}}
      {{- $assetPath := path.Join $dir $name -}}

      {{- if or (strings.HasSuffix $name ".jpg") (strings.HasSuffix $name ".jpeg") (strings.HasSuffix $name ".png") (strings.HasSuffix $name ".webp") -}}
        {{- $img := resources.Get $assetPath -}}
        {{- if $img -}}
          {{- /* Optional caption */ -}}
          {{- $captionFile := replaceRE "\\.(jpg|jpeg|png|webp)$" ".txt" $name -}}
          {{- $captionPath := path.Join "assets" $dir $captionFile -}}
          {{- $caption := "" -}}
          {{- if fileExists $captionPath -}}
            {{- $caption = readFile $captionPath | strings.TrimSpace -}}
          {{- end -}}

          {{- /* Build responsive variants with higher quality */ -}}
          {{- $widths := slice 400 600 800 1000 1280 1600 -}}

          {{- $webpSet := slice -}}
          {{- $origSet := slice -}}
          {{- range $w := $widths -}}
            {{- $wwebp := $img.Resize (printf "%dx webp q85" $w) -}}
            {{- $webpSet = $webpSet | append (printf "%s %dw" $wwebp.RelPermalink $w) -}}

            {{- $worig := $img.Resize (printf "%dx q90" $w) -}}
            {{- $origSet = $origSet | append (printf "%s %dw" $worig.RelPermalink $w) -}}
          {{- end -}}

          {{- /* Higher quality default */ -}}
          {{- $default := $img.Resize "1000x q90" -}}

          <div class="gallery-item">
            {{- if eq $zoomable "true" -}}
              {{- $zoom := $img.Resize "1800x q85" -}}
              <a href="{{ $zoom.RelPermalink }}"
                 {{- if $caption }} data-glightbox="description: {{ replace $caption `"` `&quot;` }}" {{- end }}
                 data-gallery="gallery"
                 class="glightbox">
            {{- end -}}

            <picture>
              {{- if eq $webp "true" -}}
                <source type="image/webp" srcset="{{ delimit $webpSet ", " }}" 
                        sizes="(min-width: 1400px) 20vw, (min-width: 900px) 30vw, (min-width: 600px) 45vw, 50vw">
              {{- end -}}
              <img
                src="{{ $default.RelPermalink }}"
                srcset="{{ delimit $origSet ", " }}"
                sizes="(min-width: 1400px) 20vw, (min-width: 900px) 30vw, (min-width: 600px) 45vw, 50vw"
                alt="{{ replaceRE "\\.(jpg|jpeg|png|webp)$" "" $name }}"
                loading="lazy" decoding="async"
                width="{{ $default.Width }}" height="{{ $default.Height }}" />
            </picture>

            {{- if eq $zoomable "true" -}}
              </a>
            {{- end -}}
          </div>

        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
</div>

<style>
/* Use a single custom property to keep gutters perfectly equal */
:root { --gutter: 12px; }

/* Container: responsive columns by desired column width */
.gallery{
  /* Let the browser choose how many columns fit, targeting ~300px */
  column-width: 300px;         /* auto-resizes # of columns */
  column-gap: var(--gutter);
  padding: var(--gutter);      /* equal outer spacing on all sides */
  margin: 2rem auto;
  max-width: 1400px;
  box-sizing: border-box;
}

/* Items: inline-block for CSS columns; bottom margin matches the gap */
.gallery-item{
  display: inline-block;
  width: 100%;
  margin: 0 0 var(--gutter);
  border-radius: 10px;
  overflow: hidden;
  break-inside: avoid;
  -webkit-column-break-inside: avoid;
  page-break-inside: avoid;
}

/* Images */
.gallery-item img{
  display:block;
  width:100%;
  height:auto;
  transition: transform .3s ease; /* move transition here for smoother hover */
}

.gallery-item a{ display:block; }

.gallery-item a:hover img{ transform: scale(1.02); }

/* Optional: tweak the target column width at certain breakpoints */
@media (max-width: 1200px){ .gallery{ column-width: 260px; } }
@media (max-width: 900px) { .gallery{ column-width: 220px; } }
@media (max-width: 600px) { .gallery{ column-width: 180px; } }
/* On very small screens, one column will naturally happen once the container is narrower than column-width + padding + gaps */
</style>
